// ==========================================================================
// Project:   Ember Data RESTFullYii Adapter
// Copyright: (c) 2014 Benjamin Gutschik http://gutschik.de
// License:   MIT
// ==========================================================================


// 2fe3a5d (2014-03-11 13:24:28 +0100)


!function(){DS.RESTFullYiiSerializer=DS.RESTSerializer.extend({init:function(){this._super.apply(this,arguments)},extractMeta:function(a,b,c){c&&c.data&&c.data.totalCount&&(a.metaForType(b,{total:c.data.totalCount}),delete c.data.totalCount),c&&c.message&&delete c.message,c&&c.success&&delete c.success},extract:function(a,b,c,d,e){this.extractMeta(a,b,c),c=this.normalizePayload(b,c);var f="extract"+e.charAt(0).toUpperCase()+e.substr(1);return this[f](a,b,c,d,e)},extractRESTFullYiiPayload:function(a,b,c){b.eachRelationship(function(b,d){if(Ember.isNone(c[b])||"number"==typeof c[b][0]||"string"==typeof c[b][0]||"hasMany"!==d.kind){if(!Ember.isNone(c[b])&&"object"==typeof c[b]&&"belongsTo"===d.kind){var e=c[b].id;this.pushSinglePayload(a,d.type,c[b]),c[b]=e}}else if("array"===Ember.typeOf(c[b])&&c[b].length>0){var f=c[b].mapBy("id");this.pushArrayPayload(a,d.type,c[b]),c[b]=f}},this)},normalizePayload:function(a,b){var c=Ember.String.decamelize(a.typeKey);return c=Ember.String.singularize(c),b&&b.data&&b.data[c]&&(b=b.data[c]),b},extractSingle:function(a,b,c){return this.normalize(b,c),this.extractRESTFullYiiPayload(a,b,c),c},extractArray:function(a,b,c){for(var d=this,e=0;e<c.length;e++)this.normalize(b,c[e]),d.extractRESTFullYiiPayload(a,b,c[e]);return c},pushSinglePayload:function(a,b,c){b=a.modelFor(b),c=this.extract(a,b,c,null,"find"),a.push(b,c)},pushArrayPayload:function(a,b,c){b=a.modelFor(b),c=this.extract(a,b,c,null,"findAll"),a.pushMany(b,c)},keyForAttribute:function(a){return Ember.String.decamelize(a)},keyForRelationship:function(a){return Ember.String.decamelize(a)},serializeBelongsTo:function(a,b,c){var d=c.key,e=a.get(d),f=this.keyForRelationship?this.keyForRelationship(d,"belongsTo"):d;b[f]=Ember.isNone(e)?e:"string"==typeof a.get(d)?a.get(d):a.get(d).get("id"),c.options.polymorphic&&this.serializePolymorphicType(a,b,c)},serializeHasMany:function(a,b,c){var d=c.key,e=this.keyForRelationship(d,"hasMany"),f=DS.RelationshipChange.determineRelationshipType(a.constructor,c);("manyToNone"===f||"manyToMany"===f)&&(b[e]=a.get(d).mapBy("id"))}})}(),function(){var a=Ember.get;DS.RESTFullYiiAdapter=DS.RESTAdapter.extend({defaultSerializer:"DS/RESTFullYii",pathForType:function(a){var b=Ember.String.decamelize(a);return Ember.String.singularize(b)},createRecord:function(a,b,c){var d=this.buildURL(b.typeKey),e=a.serializerFor(b.typeKey).serialize(c);return this.ajax(d,"POST",{data:e})},updateRecord:function(b,c,d){var e=b.serializerFor(c.typeKey).serialize(d),f=a(d,"id");return this.ajax(this.buildURL(c.typeKey,f),"PUT",{data:e})},findMany:function(a,b,c,d){var e,f,g;return d&&(g=this.getHasManyAttributeName(b,d,c),f=a.serializerFor(b.typeKey).keyForAttribute(g),e=this.buildFindManyUrlWithParent(b,d,f,a)),this.ajax(e,"GET")},ajax:function(a,b,c){return c=c||{},c.cache=!1,this._super(a,b,c)},buildURL:function(a,b){var c=this._super(a,b);return"/"!==c.charAt(c.length-1)&&(c+="/"),c},addFilterToUrl:function(a,b,c){var d=[],e={};return e[b]=c,d.push(e),a+=encodeURI("?filter="+JSON.stringify(d))},buildFindManyUrlWithParent:function(a,b,c,d){var e,f,g,h;if(h=this.isManyManyRelation(a,b),g=b.get("id"),h)e=b.constructor.typeKey,f=this.buildURL(e,g),f=f+c+"/";else{var i=d.serializerFor(a.typeKey).keyForAttribute(b.constructor.typeKey);f=this.buildURL(c),f=this.addFilterToUrl(f,i,g)}return f},getHasManyAttributeName:function(a,b,c){var d;return b.eachRelationship(function(e,f){var g;"hasMany"===f.kind&&f.type.typeKey===a.typeKey&&(g=b._data[e].mapBy("id"),Ember.EnumerableUtils.intersection(c,g).length===c.length&&(d=e))}),d},isManyManyRelation:function(a,b){var c=!1;return b&&b.constructor&&a.eachRelationship(function(a,d){"hasMany"===d.kind&&d.type.typeKey===b.constructor.typeKey&&(c=!0)}),c}})}(),function(){var a="1.0.1";DS.RESTFullYiiSerializer.VERSION=a,DS.RESTFullYiiAdapter.VERSION=a,Ember.libraries&&Ember.libraries.register("ember-data-restfullyii-adapter",a)}();